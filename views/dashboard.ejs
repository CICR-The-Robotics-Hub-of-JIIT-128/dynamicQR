<!DOCTYPE html>
<html lang="en">
  <%- include("partials/head2.ejs") %>
  <body>
    <div id="dashboard" class="dashboard container">
      <div class="header">
        <div class="header-content">
          <div class="header-left">
            <h1><i class="fas fa-chart-line"></i> CICR Dynamic-QR Dashboard</h1>
            <p class="header-subtitle">
              The control center for real-time QR code destinations
            </p>
          </div>
          <div class="header-right">
            <div class="user-info">
              <div class="user-avatar" id="user-avatar">A</div>
              <div class="user-details">
                <span class="welcome-text">Welcome,</span>
                <strong id="username-display" class="username">Admin</strong>
              </div>
              <form action="/logout" method="POST">
                <button type="submit" class="logout-btn">
                  <i class="fas fa-sign-out-alt"></i> Logout
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3><i class="fas fa-link"></i> Current Registration Link</h3>
          <span class="status-badge active">
            <i class="fas fa-circle"></i> ACTIVE
          </span>
        </div>
        <div class="card-body">
          <div class="current-link-wrapper">
            <div class="current-link" id="current-link">
              <% if(activeLink) { %> <%= activeLink.url %> <% } else { %> No
              active link is set. <% } %>
            </div>
            <div class="link-stats">
              <div class="stat-item">
                <i class="fas fa-users"></i>
                <span>Total Visits : <%= activeVisits %> </span>
              </div>
            </div>
          </div>

          <div class="link-actions">
            <button class="btn btn-copy" onclick="copyLink()">
              <i class="fas fa-copy"></i> Copy Link
            </button>
          </div>
          <div id="link-editor" class="link-editor" style="display: block">
            <h4><i class="fas fa-edit"></i> Update Registration Link</h4>

            <form action="/update-link" method="POST">
              <div class="form-group">
                <label for="new-link-input">New Registration URL</label>
                <input
                  type="url"
                  id="new-link-input"
                  class="form-input"
                  name="newLinkUrl"
                  placeholder="https://example.com/new-registration"
                  required
                />
              </div>
              <div class="link-actions">
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-save"></i> Save Changes
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="cancelEdit()"
                >
                  <i class="fas fa-times"></i> Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3><i class="fas fa-history"></i> Link History & Submissions</h3>
        </div>
        <div class="card-body">
          <div class="stats-row">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-link"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number"><%= totalLinks %></div>
                <div class="stat-label">Total Links</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon success">
                <i class="fas fa-users"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number"><%= totalVisits %></div>
                <div class="stat-label">Total Visits</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon warning">
                <i class="fas fa-chart-trending-up"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number"><%= activeVisits %></div>
                <div class="stat-label">Active Link Visits</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon info">
                <i class="fas fa-calendar-week"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number"><%= newLinksThisWeek %></div>
                <div class="stat-label">New Links This Week</div>
              </div>
            </div>
          </div>

          <div class="table-container">
            <table class="history-table">
              <thead>
                <tr>
                  <th><i class="fas fa-link"></i> Registration Link</th>
                  <th><i class="fas fa-calendar"></i> Date Created</th>
                  <th><i class="fas fa-mouse-pointer"></i> Visits</th> <th><i class="fas fa-info-circle"></i> Status</th>
                  <th><i class="fas fa-cogs"></i> Actions</th>
                </tr>
              </thead>
              <tbody id="history-table-body">
                <% if (links && links.length > 0) { %>
                  <% links.forEach(link => { %>
                    <tr>
                      <td><a href="<%= link.url %>" target="_blank"><%= link.url %></a></td>
                      <td><%= new Date(link.createdAt).toLocaleDateString() %></td>
                      
                      <td><%= link.visitCount %></td>
                      
                      <td>
                        <% if (link.isActive) { %>
                          <span class="status-badge active"><i class="fas fa-circle"></i> ACTIVE</span>
                        <% } else { %>
                          <span class="status-badge inactive"><i class="fas fa-circle"></i> INACTIVE</span>
                        <% } %>
                      </td>
                      <td>
                        <% if (!link.isActive) { %>
                          <div class="action-buttons-container">
                            <form action="/set-active/<%= link._id %>" method="POST" style="margin: 0;">
                              <button type="submit" class="btn-action btn-set-active">Set Active</button>
                            </form>
                            <form action="/delete-link/<%= link._id %>?_method=DELETE" method="POST" style="margin: 0;" onsubmit="return confirm('Are you sure you want to delete this link?');">
                              <button type="submit" class="btn-action btn-remove"><i class="fas fa-trash"></i> Remove</button>
                            </form>
                          </div>
                        <% } %>
                      </td>
                    </tr>
                  <% }) %>
                <% } else { %>
                  <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                      No link history found.
                    </td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
      function copyLink() {
        const linkElement = document.getElementById('current-link');
        const linkText = linkElement.textContent.trim();

        const copyButton = document.querySelector('.btn-copy');

        if (linkText && !linkText.toLowerCase().includes('no active link')) {
          navigator.clipboard.writeText(linkText).then(() => {
            const originalButtonText = copyButton.innerHTML;
            copyButton.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
              copyButton.innerHTML = originalButtonText;
            }, 2000);
          }).catch(err => {
            console.error('Failed to copy link: ', err);
            alert('Could not copy link to clipboard.');
          });
        } else {
          alert('No active link is set to be copied.');
        }
      }
    </script>
</html>